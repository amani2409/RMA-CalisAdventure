<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Calis Adventure</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var player,
        carrots,
        dandelion,
        basil,
        ivy,
        lily,
        tulip,
        daisy,
        fox,
        platforms,
        cursors,
        keyQ,
        health = 100,
        gameOver = false,
        healthText,
        jumpVelocity = -330,
        vulnerableTime = 1000,
        camera,
        hud;


    // no good plants: tulpe, lilie, efeu
    // good plants: dandelion, gaenseblümchen, basilikum

    var titleScreen = new Phaser.Scene("titleScreen");
    var levelScreen = new Phaser.Scene("levelScreen");
    var gameScene = new Phaser.Scene("game");
    var endScreen = new Phaser.Scene("endScreen");

    titleScreen.preload = function () {
        this.load.setBaseURL("assets");

        this.load.image("main", "start.png");
    }

    titleScreen.create = function () {
        this.add.image(400, 300, 'main');

        //add some text
        this.add.text(config.width / 2, config.height / 2 + 70, 'CLICK TO START', {
            fontSize: 32,
            color: '#ffffff'
        }).setShadow(4, 4, "#000000", 2, false, true).setOrigin(0.5);

        //add click / tap to start game
        this.input.on('pointerdown', function (pointer) {
            titleScreen.scene.start('game');
        });
    }

    endScreen.create = function () {
        this.add.image(400, 300, 'main');

        //add some text
        this.add.text(config.width / 2, config.height / 2 + 70, 'GAME OVER\nCLICK TO RESTART', {
            fontSize: 32,
            color: '#ffffff',
            align: 'center'
        }).setShadow(4, 4, "#000000", 2, false, true).setOrigin(0.5);

        this.input.on('pointerdown', function (pointer) {
            //shut down this scene and start up the game scene
            endScreen.scene.start('game');
            //restart the scene to reset all the variables!
            gameScene.scene.restart();
        });
    }

    gameScene.preload = function () {
        this.load.setBaseURL("assets");
        this.load.image('background', 'background.png');
        this.load.image('ground', 'ground1.png');
        this.load.image('carrot', 'carrot.png');


        // good plants: dandelion, gaenseblümchen, basilikum
        // no good plants: tulpe, lilie, efeu

        // good plant:
        this.load.image('dandelion', 'dandelion.png');
        this.load.image('daisy', 'daisy.png');
        this.load.image('basil', 'basil.png');

        // bad plant:
        this.load.image('tulip', 'tulip.png');
        this.load.image('lily', 'lily.png');
        this.load.image('ivy', 'ivy.png');


        this.load.spritesheet('bunny', 'bunnysprite.png', {frameWidth: 80, frameHeight: 50}); //created my own bunny spritesheet

        this.load.spritesheet('fox', 'fox.png', {frameWidth: 36, frameHeight: 21}); // from https://opengameart.org/content/fox-wolf-pack-rework

    }

    gameScene.create = function () {
        //  A simple background for our game
        var background = this.add.sprite(config.width / 2, 300, 'background');
        background.alpha = 0.8;
        background.setScrollFactor(0.2);

        //  The platforms group contains the ground and the 2 ledges we can jump on
        platforms = this.physics.add.staticGroup();

        //  Here we create the ground.
        //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
        platforms.create(400, 580, 'ground').setScale(2).refreshBody();
        platforms.create(1000, 580, 'ground').setScale(2).refreshBody();
        platforms.create(1600, 580, 'ground').setScale(2).refreshBody();
        platforms.create(580, 580, 'ground').setScale(2).refreshBody();
        platforms.create(150, 240, 'ground');


        // setting plants
        daisy = this.physics.add.staticGroup();
        daisy.enableBody = true;
        daisy = daisy.create(800, 500, 'daisy').setScale(0.05);
        daisy.body.immovable = true;

        ivy = this.physics.add.staticGroup();
        ivy.enableBody = true;
        ivy = ivy.create(1200, 500, 'ivy').setScale(0.05);
        ivy.body.immovable = true;


        // The player and its settings
        player = this.physics.add.sprite(100, 450, 'bunny');

        //  Player physics properties. Give the little guy a slight bounce.
        player.setBounce(0.2);
        player.setOrigin(.5, .5);
        player.setDrag(1);
        player.setCollideWorldBounds(true);


        //  Our player animations, turning, walking left and walking right.
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('bunny', {start: 0, end: 2}),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [{key: 'bunny', frame: 5}],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('bunny', {start: 3, end: 5}),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'down',
            frames: [{key: 'bunny', frame: 6}],
            frameRate: 20
        });

        // Fox NPC walking left
        fox = this.physics.add.sprite(600,400, 'fox').setScale(3);
        fox.setCollideWorldBounds(true);

        this.anims.create({
            key: 'foxWalkingLeft',
            frames: this.anims.generateFrameNumbers('fox', {start: 3, end: 5}),
            frameRate: 10,
            repeat: -1
        });

        fox.anims.play('foxWalkingLeft', true);

        fox.body.velocity.x = -80;
        // fox.maxDistance = 200;
        fox.previousX = fox.x;

        //  Input Events
        cursors = this.input.keyboard.createCursorKeys();

        keyQ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Q);

        //  Some carrots to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
        carrots = this.physics.add.group({
            key: 'carrot',
            repeat: 11,
            setXY: {x: 12, y: 0, stepX: 70}
        });

        carrots.children.iterate(function (child) {
            //  Give each star a slightly different bounce
            child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

        });

        //  The healthbar
        healthText = this.add.text(16, 16, 'Health: 100', {fontSize: '32px', fill: '#000'});
        healthText.setScrollFactor(0);

        this.physics.world.setBounds(0, 0, 2000, 580);

        //  Collide the player and the carrots with the platforms
        this.physics.add.collider(player, platforms);
        this.physics.add.collider(carrots, platforms);
        this.physics.add.collider(fox, platforms);
        // this.physics.add.collider(daisy, platforms);
        // this.physics.add.collider(ivy, platforms);

        //  Checks to see if the player overlaps with any of the carrots, if he does call the collectPlants function
        this.physics.add.overlap(player, carrots, collectPlants, null, this);
        // this.physics.add.overlap(player, dandelion, collectPlants, null, this);
        // this.physics.add.overlap(player, thyme, collectPlants, null, this);

        this.physics.add.overlap(player, fox, hitFox, null, this);
        this.physics.add.overlap(player, daisy, collectGoodPlants, null, this);
        // this.physics.add.overlap(player, ivy, collectBadPlants, null, this);


        camera = this.cameras.main;
        camera.setBounds(0, 0, 2000, 580);
        camera.startFollow(player, true, 0.05, 0, -200, 120);
        camera.setFollowOffset(-200, 120);

    }

    gameScene.update = function () {
        //
        // console.log('Player X:', player.x);
        // console.log('Camera X:', camera.scrollX);

        if (gameOver) {
            return;
        }

        // if(keyQ){
        //     player.setVelocityX(0);
        //
        //     player.anims.play('down');
        // }

        if (cursors.left.isDown) {
            player.setVelocityX(-160);

            player.anims.play('left', true);

        } else if (cursors.right.isDown) {
            player.setVelocityX(160);

            player.anims.play('right', true);

        } else if (cursors.down.isDown) {
            player.setVelocityX(0);

            player.anims.play('down');
        } else {
            player.setVelocityX(0);

            player.anims.play('turn');
        }

        if (cursors.up.isDown && player.body.touching.down) {
            player.setVelocityY(-330);
        }


    }

    function restartGame(scene) {
        gameScene.scene.start('endScreen');
    }

    function collectGoodPlants(player, plant) {
        plant.disableBody(true, true);

        //  Add and update the Health
        health += 10;
        healthText.setText('Health: ' + health);

        if (carrots.countActive(true) === 100) {
            //  A new batch of carrots to collect
            carrots.children.iterate(function (child) {

                child.enableBody(true, child.x, 0, true, true);

            });

        }
    }

    function collectBadPlants(player, plant) {
        plant.disableBody(true, true);

        //  Add and update the Health
        health -= 10;
        healthText.setText('Health: ' + health);

        if (carrots.countActive(true) === 100) {
            //  A new batch of carrots to collect
            carrots.children.iterate(function (child) {

                child.enableBody(true, child.x, 0, true, true);

            });

        }
    }


    function collectPlants(player, plant) {
        plant.disableBody(true, true);

        //  Add and update the Health
        health += 10;
        healthText.setText('Health: ' + health);

        if (carrots.countActive(true) === 100) {
            //  A new batch of carrots to collect
            carrots.children.iterate(function (child) {

                child.enableBody(true, child.x, 0, true, true);

            });

        }
    }

    function hitFox(player, fox) {

        if(fox.hit && health > 0){
           fox.disableBody(false,false);
           player.setVelocityY(jumpVelocity)

            var tween = this.tweens.add({
               targets: fox,
                alpha: 0.3,
                scaleX: 1.5,
                scaleY: 1.5,
                ease: 'Linear',
                duration: 200,
                onComplete: function() {
                    destroyGameObject(fox);
                },
            });

        }
        else {
            //if not invulnerable
            if(!player.invulnerable){
                player.invulnerable = true;

                health -= 50;
                healthText.setText('Health: ' + health);

                if(health <= 0){
                    restartGame();
                }
                else {
                    player.body.velocity.x = 0;
                    player.body.velocity.y = -220;

                    var tween = this.tweens.add({
                        targets: player,
                        alpha: 0.8,
                        ease: 'Linear',
                        duration: 200,
                        onCompleteScope: this
                    });

                    var timer = this.time.delayedCall(vulnerableTime, playerVulnerable, [this]);

                }

            }
        }
    }


    function playerVulnerable(game) {
        //tween player back to 100% opacity and reset invulnerability flag
        var death = game.tweens.add({
            targets: player,
            alpha: 1,
            ease: 'Linear',
            duration: 200,
            onComplete: function() {
                player.invulnerable = false;
            },
            onCompleteScope: this
        });
    }

    function destroyGameObject(gameObject) {
        // Removes any game object from the screen
        gameObject.destroy();
    }

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        transparent: true,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 300},
                fps: 120,
                debug: false
            }
        },
        scene: [titleScreen, gameScene, endScreen]

    };

    var game = new Phaser.Game(config);

</script>

</body>
</html>